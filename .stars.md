# Astral `.stars` Format Specification v2

## Overview

The `.stars` format v2 provides a structured, type-safe way to define package recipes for Astral package manager. It combines syntax inspiration from Rust, Nix, and C to create a readable and powerful configuration language.

## Format Version Detection

Astral automatically detects the format version:
- **v2**: Detected by presence of `$PKG.` declarations
- **v1**: Legacy format with `@SECTION` markers (backward compatible)

---

## Basic Syntax

### Comments
```
# This is a single-line comment
```

### Sections
Sections use the `$PKG.SectionName: { }` syntax:
```
$PKG.Metadata: {
    KEY = "value"
};
```

### Data Sections
Data sections also use `$PKG.SectionName { }` syntax:
```
$PKG.Sources {
    urls = "https://example.com/file.tar.gz"
};
```

---

## Core Sections

### 1. Metadata Section
**Required**: Yes  
**Syntax**: `$PKG.Metadata: { KEY = "VALUE"; }`

```
$PKG.Metadata: {
    VERSION = "1.0.0"
    DESCRIPTION = "Short package description"
    HOMEPAGE = "https://example.com"
    CATEGORY = "app-misc"
};
```

**Available Keys**:
- `VERSION` (required): Package version string
- `DESCRIPTION` (optional): One-line description
- `HOMEPAGE` (optional): Project homepage URL
- `CATEGORY` (optional): Package category (e.g., sys-libs, dev-util)

---

### 2. Dependency Section
**Required**: No  
**Syntax**: `$PKG.Depend { subsections }`

```
$PKG.Depend {
    $PKG.Depend.BDepends {
        gcc >= 11.0
        cmake >= 3.20
        make
    };
    
    $PKG.Depend.RDepends {
        glibc >= 2.35
        openssl
    };
};
```

**Subsections**:
- `BDepends`: Build-time dependencies (compilers, build tools)
- `RDepends`: Runtime dependencies (libraries, utilities)

**Versioning Syntax**:
```
package_name >= 1.2.3
package_name <= 2.0.0
package_name = 1.5.0
package_name   # Any version
```

---

### 3. Build Section
**Required**: Yes  
**Syntax**: `$PKG.Build [IF condition] { script }`

```
$PKG.Build {
    ./configure --prefix=/usr
    make -j$(nproc)
};
```

**With Conditions** (Architecture-specific):
```
$PKG.Build [IF arch=x86_64] {
    # x86_64-specific build
    ./configure --prefix=/usr --enable-sse4
    make -j$(nproc)
};

$PKG.Build [IF arch=aarch64] {
    # ARM64-specific build
    ./configure --prefix=/usr --host=aarch64-linux-gnu
    make
};
```

**Available Conditions**:
- `[IF arch=x86_64]` - Intel/AMD 64-bit
- `[IF arch=aarch64]` - ARM 64-bit
- `[IF arch=riscv64]` - RISC-V 64-bit

**Build Environment Variables**:
- `$PKGDIR` or `$DESTDIR`: Package staging directory
- `$CFLAGS`, `$CXXFLAGS`, `$LDFLAGS`: Compiler flags (from make.conf)
- `$MAKEFLAGS`: Make parallelism flags

---

### 4. Package Section
**Required**: No (but recommended)  
**Syntax**: `$PKG.Package { script }`

```
$PKG.Package {
    cd build-dir
    make DESTDIR="$PKGDIR" install
    
    # Install additional files
    install -Dm644 README.md "$PKGDIR/usr/share/doc/$PKG/README"
};
```

**Purpose**: Defines how to install files into `$PKGDIR` after building.

---

### 5. Sources Section
**Required**: Yes (if downloading files)  
**Syntax**: `$PKG.Sources { urls = "..." }`

```
$PKG.Sources {
    urls = "https://example.com/package-1.0.0.tar.gz"
};
```

**Multiple Sources**:
```
$PKG.Sources {
    urls = "https://example.com/source.tar.gz"
    urls = "https://example.com/patch-001.patch"
};
```

**Variable Substitution** (planned):
```
$PKG.Sources {
    urls = "https://example.com/package-${VERSION}.tar.gz"
};
```

---

### 6. Checksums Section
**Required**: No (but recommended)  
**Syntax**: `$PKG.Checksums { hash filename }`

```
$PKG.Checksums {
    sha256:fb53c30b58a81fe0b3b4e64aedb9a53311ddda301ec9c1c2b42d659e50f5e13a glibc-2.38.tar.xz
};
```

**Format**: `algorithm:hash filename`

**Supported Algorithms**:
- `sha256` (recommended)
- `sha512`
- `md5` (not recommended)

---

### 7. Post-Install Section
**Required**: No  
**Syntax**: `$PKG.PostInstall { script }`

```
$PKG.PostInstall {
    # Update system caches
    ldconfig
    update-desktop-database
    
    echo "Package installed successfully!"
};
```

**Purpose**: Runs after package installation to update caches, generate files, etc.

---

### 8. Post-Remove Section
**Required**: No  
**Syntax**: `$PKG.PostRemove { script }`

```
$PKG.PostRemove {
    echo "Package removed. Consider cleaning configuration files."
};
```

**Purpose**: Cleanup tasks after package removal.

---

## Complete Example

```
$PKG.Metadata: {
    VERSION = "1.5.2"
    DESCRIPTION = "Example application demonstrating new format"
    HOMEPAGE = "https://github.com/example/app"
    CATEGORY = "app-misc"
};

$PKG.Depend {
    $PKG.Depend.BDepends {
        gcc >= 11.0
        cmake >= 3.20
        pkg-config
    };
    
    $PKG.Depend.RDepends {
        glibc >= 2.35
        zlib
        openssl >= 3.0
    };
};

$PKG.Sources {
    urls = "https://github.com/example/app/archive/v1.5.2.tar.gz"
};

$PKG.Checksums {
    sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855 v1.5.2.tar.gz
};

$PKG.Build {
    cd app-1.5.2
    mkdir -p build
    cd build
    
    cmake .. \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_BUILD_TYPE=Release
    
    make -j$(nproc)
};

$PKG.Package {
    cd app-1.5.2/build
    make DESTDIR="$PKGDIR" install
    
    # Install documentation
    install -Dm644 ../README.md "$PKGDIR/usr/share/doc/app/README"
    install -Dm644 ../LICENSE "$PKGDIR/usr/share/licenses/app/LICENSE"
};

$PKG.PostInstall {
    echo "Example app installed successfully!"
    echo "Run 'app --help' to get started."
};
```

---

## Advanced Features

### Conditional Compilation

Build different configurations based on system architecture:

```
$PKG.Build [IF arch=x86_64] {
    ./configure --prefix=/usr --enable-sse4 --enable-avx2
    make -j$(nproc)
};

$PKG.Build [IF arch=aarch64] {
    ./configure --prefix=/usr --enable-neon
    make -j$(nproc)
};

$PKG.Build [IF arch=riscv64] {
    ./configure --prefix=/usr --disable-asm
    make
};
```

### Nested Structures

Dependencies support nested subsections for clarity:

```
$PKG.Depend {
    # Build-time only
    $PKG.Depend.BDepends {
        rust >= 1.70
        cargo
    };
    
    # Runtime only
    $PKG.Depend.RDepends {
        libssl
    };
};
```

---

## Migration from v1 Format

### v1 Format (Old):
```
VERSION=1.0.0
DESCRIPTION=My package

@BUILD
./configure
make

@DEPENDS
gcc
make
```

### v2 Format (New):
```
$PKG.Metadata: {
    VERSION = "1.0.0"
    DESCRIPTION = "My package"
};

$PKG.Build {
    ./configure
    make
};

$PKG.Depend {
    $PKG.Depend.BDepends {
        gcc
        make
    };
};
```

**Note**: Astral supports both formats automatically via version detection.

---

## Best Practices

1. **Always include checksums** for downloaded sources
2. **Use versioned dependencies** when compatibility matters
3. **Keep build scripts simple** - complex logic should be in upstream build system
4. **Test on multiple architectures** if using conditional builds
5. **Document non-obvious build steps** with comments
6. **Use `$PKGDIR` consistently** in package scripts

---

## Future Extensions (Planned)

- `[IF os=linux]` - OS-specific builds
- `[IF feature=systemd]` - Feature flag support
- `[IF use=multilib]` - USE flag integration
- `${VARIABLE}` substitution in sources
- Array syntax for multiple sources: `urls = ["url1", "url2"]`

---

## Error Handling

### Syntax Errors
Astral will report:
- Missing closing braces
- Invalid section names
- Malformed KEY=VALUE pairs

### Common Mistakes (yes, including myself)
```
# Wrong: Missing quotes
VERSION = 1.0.0

# Correct:
VERSION = "1.0.0"

# Wrong: Forgot closing brace
$PKG.Build {
    make

# âœ“ Correct:
$PKG.Build {
    make
};
```

---

## Validation Tools (Coming Soon)

```bash
# Validate .stars file syntax
astral --validate package.stars

# Convert v1 to v2 format
astral --migrate-stars package-old.stars > package-new.stars
```

---

## See Also

- Astral Package Manager Documentation
- `astral --help`
- Example recipes: `/usr/src/astral/recipes/`
